const MOVIE_POSTERS = [
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/8ff1ee46af3eeb9b4c50a155bed315ff97902ea3/assets/posters/777%20Charlie.jpg", 
        correct: "777 Charlie", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Amar%20Akbar%20Anthony.jpg"
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Apthamitra.jpg", 
        correct: "Apthamitra", 
        lang: "Kannada" 
    },

    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Arudhati.jpg", 
        correct: "Arundhati", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/8ff1ee46af3eeb9b4c50a155bed315ff97902ea3/assets/Arya%202.jpg", 
        correct: "Arya 2", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Avane%20Srimannarayana.jpg", 
        correct: "Avane Srimannarayana", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Avengers%20EndGame.jpg", 
        correct: "Avengers: Endgame", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Bad%20Boys%20for%20Life.jpg", 
        correct: "Bad Boys for Life", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Bahubali%201.jpeg", 
        correct: "Baahubali 1: The Beginning", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Bell%20Bottom.jpg", 
        correct: "Bell Bottom", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Bhaag%20Milka%20Bhaag.jpg", 
        correct: "Bhaag Milkha Bhaag", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/BhadriNath.jpg", 
        correct: "Badrinath", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Bharat%20Anne%20Nenu.jpg", 
        correct: "Bharat Ane Nenu", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Caribbean%20The%20Curse%20of%20the%20Black%20Pearl.jpg", 
        correct: "Pirates of the Caribbean: The Curse of the Black Pearl", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Chak%20De%20India.jpg", 
        correct: "Chak De! India", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Chatrapati.jpg", 
        correct: "Chatrapathi", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Dabaang.jpg", 
        correct: "Dabangg", 
        lang: "Hindi" 
    },

    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Devdas.jpg", 
        correct: "Devdas", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Dhoom%202.jpg", 
        correct: "Dhoom 2", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Dil%20To%20Pagal%20Hai.jpg", 
        correct: "Dil To Pagal Hai", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Dilwale%20Dulhania%20Lejainge.jpg", 
        correct: "Dilwale Dulhania Le Jayenge", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Dookudu.jpg", 
        correct: "Dookudu", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Dune.jpg", 
        correct: "Dune", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/English%20Vinglish.jpg", 
        correct: "English Vinglish", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Gabbar%20Singh.jpg", 
        correct: "Gabbar Singh", 
        lang: "Telugu" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Galipata.jpg", 
        correct: "Gaalipata", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Gangubai%20Kathaiwadi.jpg", 
        correct: "Gangubai Kathiawadi", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Golmal.jpg", 
        correct: "Golmaal", 
        lang: "Hindi" 
    },
    
    { 
        url: "hhttps://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Hangover.jpg", 
        correct: "The Hangover", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Jab%20We%20Met.jpg", 
        correct: "Jab We Met", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Jhoda%20Akbar.jpg", 
        correct: "Jodhaa Akbar", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/John%20Wick.jpg", 
        correct: "John Wick", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Jumanji.jpeg", 
        correct: "Jumanji", 
        lang: "English" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/KGF1.jpg", 
        correct: "KGF Chapter 1", 
        lang: "Kannada" 
    },

    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/KGF2.jpg", 
        correct: "KGF Chapter 2", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Kabhi%20Khusi%20Khabi%20Gham.jpg", 
        correct: "Kabhi Khushi Kabhie Gham", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Kantara%20.jpg", 
        correct: "Kantara", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Kantara%20chap%201.jpg", 
        correct: "Kantara: A Legend Chapter-1", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Kirik%20Party.jpg", 
        correct: "Kirik Party", 
        lang: "Kannada" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Lagaan.jpg", 
        correct: "Lagaan", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/Kuch%20Kuch%20Hota%20Hai.jpg", 
        correct: "Kuch Kuch Hota Hai", 
        lang: "Hindi" 
    },
    
    { 
        url: "https://raw.githubusercontent.com/RJ-xx/FSD-Project---Movie-Posters/main/assets/posters/MOM.png", 
        correct: "MOM", 
        lang: "Hindi" 
    },
    
    
];

// --- 2. DOM ELEMENTS & GAME STATE ---
const posterEl = document.getElementById('poster');
const posterSubEl = document.getElementById('posterSub');
const scoreEl = document.getElementById('score');
const attemptsEl = document.getElementById('attempts');
const streakEl = document.getElementById('streak');
const optionsContainer = document.getElementById('optionsContainer');
const nextBtn = document.getElementById('nextBtn');
const revealBtn = document.getElementById('revealBtn');
const feedbackArea = document.getElementById('feedbackArea');
const timeLeftEl = document.getElementById('timeLeft');
const timeFillEl = document.getElementById('timeFill');
// Removed startButton and coverPage references for cleanup
const quizContainer = document.getElementById('quizContainer');
const movieListEl = document.getElementById('movieList');

let currentMovie = null;
let currentMovieIndex = -1;
let score = 0;
let streak = 0;
let attempts = 0;
let timeLimit = 15; // seconds
let timer = null;
let gameActive = false;
const MAX_ROUNDS = 5; // Total rounds to play
let currentRound = 0;

// --- 3. HELPER FUNCTIONS ---

/** Shuffles an array in place using the Fisher-Yates algorithm. */
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

/** Updates the displayed score, streak, and attempts. */
function updateStats() {
    scoreEl.textContent = score;
    attemptsEl.textContent = attempts;
    streakEl.textContent = streak;
}

/** Updates the round tracker circles in the header. */
function updateRoundTracker() {
    const circles = document.querySelectorAll('.round-circles .circle');
    circles.forEach((circle, index) => {
        circle.classList.remove('current');
        circle.classList.remove('finished');

        if (index === currentRound - 1) {
            circle.classList.add('current');
        } else if (index < currentRound - 1) {
            circle.classList.add('finished');
        }
    });
}

/** Renders the multiple choice buttons dynamically. */
function renderOptions() {
    optionsContainer.innerHTML = '';
    
    // Check if we have enough movies to run the quiz
    if (MOVIE_POSTERS.length < 4) {
        optionsContainer.innerHTML = '<p style="color:var(--color-error); text-align:center;">Need at least 4 unique movies to generate options!</p>';
        return;
    }

    // Get the correct movie title and all other movie titles for incorrect options
    const correctTitle = currentMovie.correct;
    const allTitles = MOVIE_POSTERS.map(m => m.correct);
    
    // Filter out the correct title to get a pool of incorrect options
    let incorrectPool = allTitles.filter(title => title !== correctTitle);
    
    // Shuffle the pool and select the first three (or fewer if not enough)
    shuffleArray(incorrectPool);
    const incorrectOptions = incorrectPool.slice(0, 3);

    // Combine correct and incorrect options
    let finalOptions = [...incorrectOptions, correctTitle];
    shuffleArray(finalOptions);

    finalOptions.forEach((optionText, index) => {
        const button = document.createElement('button');
        button.className = 'option-btn';
        button.textContent = optionText;
        button.dataset.answer = optionText;
        button.dataset.index = index; 

        // Event listener for the user's guess
        button.addEventListener('click', () => handleGuess(optionText));

        optionsContainer.appendChild(button);
    });
}

/** Enables or disables all option buttons. */
function toggleOptions(enabled) {
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = !enabled;
    });
}

/** Resets timer visually and stops the interval. */
function stopTimer(reset = true) {
    clearInterval(timer);
    if (reset) {
        timeLeftEl.textContent = `${timeLimit}s`;
        timeFillEl.style.width = '100%';
        timeLeftEl.style.color = 'var(--color-success)';
    }
    // Remove the long transition property to allow instant reset
    timeFillEl.style.transition = 'none';
}

/** Starts the countdown timer. */
function startTimer() {
    stopTimer(); // Clear any existing timer
    let currentTime = timeLimit;

    // Set width transition to full 0 to 100% over the time limit
    // We add a small delay and re-apply transition to enable a smooth reset
    setTimeout(() => {
        timeFillEl.style.transition = `width ${timeLimit}s linear`;
        timeFillEl.style.width = '0%';
    }, 50); 
    
    timeLeftEl.textContent = `${currentTime}s`;

    timer = setInterval(() => {
        currentTime--;
        timeLeftEl.textContent = `${currentTime}s`;

        // Change color based on time remaining
        if (currentTime <= 5) {
            timeLeftEl.style.color = 'var(--color-secondary)'; // Red/Orange
        } else {
            timeLeftEl.style.color = 'var(--color-success)'; // Green
        }
        
        if (currentTime <= 0) {
            handleTimeout();
        }
    }, 1000);
}


// --- 4. GAME LOGIC ---

/** Logic for when the timer runs out. */
function handleTimeout() {
    stopTimer(false);
    attempts++;
    streak = 0;
    updateStats();
    
    showResult(false);

    feedbackArea.className = 'feedback incorrect';
    feedbackArea.innerHTML = `Time up! The correct answer was <strong>${currentMovie.correct}</strong>.`;
    
    toggleOptions(false);
    nextBtn.classList.remove('disabled');
    nextBtn.disabled = false;
}

/** Loads and displays a new random movie poster and options. */
function loadQuestion() {
    if (currentRound >= MAX_ROUNDS) {
        endGame();
        return;
    }
    currentRound++;
    updateRoundTracker();

    // Reset controls and feedback
    toggleOptions(true);
    nextBtn.classList.add('disabled');
    nextBtn.disabled = true;
    revealBtn.disabled = false;
    feedbackArea.className = 'feedback';
    feedbackArea.textContent = 'Click an option to submit your answer.';

    // 1. Select a random movie
    const remainingMovies = MOVIE_POSTERS.filter(m => m !== currentMovie);
    shuffleArray(remainingMovies);
    currentMovie = remainingMovies[0] || MOVIE_POSTERS[0]; // Fallback just in case

    // 2. Display the poster image
    posterEl.innerHTML = '';
    
    // Handle the case where the MOVIE_POSTERS array is empty
    if (!currentMovie || !currentMovie.url) {
        posterEl.innerHTML = '<span style="font-size: 1rem;">No movie data loaded. Please check MOVIE_POSTERS array.</span>';
        posterSubEl.textContent = 'Data Missing';
        return;
    }
    
    const img = document.createElement('img');
    img.src = currentMovie.url;
    img.alt = `Poster for ${currentMovie.correct}`;
    img.className = 'actual-poster';
    
    // --- CRITICAL IMAGE ERROR HANDLER ---
    img.onerror = function() {
        console.error("‚ùå IMAGE LOAD FAILED! Check the URL:", currentMovie.url);
        // Fallback to text/emoji if image fails
        posterEl.innerHTML = '<span style="font-size: 8rem;">‚ö†Ô∏è</span>';
        posterSubEl.textContent = 'Image failed to load. Check your URL in the console.';
    };

    posterEl.appendChild(img);
    posterSubEl.textContent = `Language: ${currentMovie.lang}`;

    // 3. Render the options and start the timer
    renderOptions(); // Removed unnecessary argument
    startTimer();
}

/** Handles user selecting an option. */
function handleGuess(guessedTitle) {
    stopTimer(false);

    toggleOptions(false);
    
    const isCorrect = (guessedTitle.toLowerCase() === currentMovie.correct.toLowerCase());

    attempts++;

    if (isCorrect) {
        score += 10;
        streak++;
        feedbackArea.className = 'feedback correct';
        feedbackArea.innerHTML = `‚úÖ Correct! Well done!`;
    } else {
        streak = 0;
        feedbackArea.className = 'feedback incorrect';
        feedbackArea.innerHTML = `‚ùå Incorrect. The correct film was <strong>${currentMovie.correct}</strong>.`;
    }

    showResult(isCorrect, guessedTitle);
    
    updateStats();
    nextBtn.classList.remove('disabled');
    nextBtn.disabled = false;
}

/** Visually highlights the correct/incorrect answer on the buttons. */
function showResult(guessedCorrectly, guessedTitle = null) {
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.disabled = true;

        if (btn.dataset.answer.toLowerCase() === currentMovie.correct.toLowerCase()) {
            btn.classList.add('correct');
        } else if (!guessedCorrectly && btn.dataset.answer.toLowerCase() === guessedTitle?.toLowerCase()) {
            btn.classList.add('incorrect');
        }
    });
    revealBtn.disabled = true;
}

/** Reveals the answer without a guess (counts as a miss). */
function handleReveal() {
    stopTimer(false);
    attempts++;
    streak = 0;
    updateStats();
    showResult(false);
    
    feedbackArea.className = 'feedback incorrect';
    feedbackArea.innerHTML = `Skipped. The correct film was <strong>${currentMovie.correct}</strong>.`;
    
    toggleOptions(false);
    nextBtn.classList.remove('disabled');
    nextBtn.disabled = false;
}

/** Displays the final score screen. */
function endGame() {
    stopTimer(true);
    posterEl.innerHTML = '<span style="font-size: 8rem;">üèÜ</span>';
    posterSubEl.textContent = 'Game Over!';
    optionsContainer.innerHTML = `<p style="text-align:center; font-size:1.2rem;">You scored ${score} points in ${MAX_ROUNDS} rounds!</p>`;
    feedbackArea.textContent = 'Press NEXT to start a new game.';

    nextBtn.textContent = 'Play Again';
    nextBtn.classList.remove('disabled');
    nextBtn.disabled = false;
    revealBtn.disabled = true;
}

/** Resets all game variables and restarts the quiz. */
function resetGame() {
    score = 0;
    streak = 0;
    attempts = 0;
    currentRound = 0;
    currentMovie = null;
    nextBtn.textContent = 'Next Question ‚ñ∂';
    updateStats();
    updateRoundTracker();
    loadQuestion();
}

/** Pre-populates the movie list in the <details> section. */
function populateMovieList() {
    movieListEl.innerHTML = MOVIE_POSTERS.map(movie => 
        `<div><img src="${movie.url}" style="width: 20px; height: auto; margin-right: 5px; border-radius: 3px;" onerror="this.src='https://placehold.co/20x30/333/fff?text=?'" /> <strong>${movie.correct}</strong> (${movie.lang})</div>`
    ).join('');
}

// --- 5. INITIALIZATION & EVENT LISTENERS ---

/** Initializes the application after the document loads. */
function initApp() {
    populateMovieList();
    
    // --- IMMEDIATE START LOGIC (Replaces cover page logic) ---
    // Start the game immediately when the page loads, as requested.
    gameActive = true;
    resetGame();
    // --------------------------------------------------------

    // 2. Quiz Controls
    nextBtn.addEventListener('click', () => {
        if (nextBtn.textContent === 'Play Again') {
            resetGame();
        } else {
            loadQuestion();
        }
    });
    
    revealBtn.addEventListener('click', handleReveal);
}

// Ensure the app starts when the page structure is ready
document.addEventListener('DOMContentLoaded', initApp);